<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>VOE - Admin Dashboard</title>
  <!-- Favicon icon -->
  <link rel="icon" type="image/png" sizes="16x16" href="./images/favicon.png">
  <link href="../dashBoard/css/style.css" rel="stylesheet">

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <style>
    .question-options {
      display: none;
    }
  </style>

</head>

<body>

  <!--*******************
        Preloader start
    ********************-->
  <div id="preloader">
    <div class="sk-three-bounce">
      <div class="sk-child sk-bounce1"></div>
      <div class="sk-child sk-bounce2"></div>
      <div class="sk-child sk-bounce3"></div>
    </div>
  </div>
  <!--*******************
        Preloader end
    ********************-->


  <!--**********************************
        Main wrapper start
    ***********************************-->
  <div id="main-wrapper">

    <!--**********************************
            Nav header start
        ***********************************-->
    <%- include('./partials/nav-header') %>
      <!--**********************************
            Nav header end
        ***********************************-->

      <!--**********************************
            Header start
        ***********************************-->
      <%- include('./partials/header') %>
        <!--**********************************
            Header end ti-comment-alt
        ***********************************-->

        <!--**********************************
            Sidebar start
        ***********************************-->
        <%- include('./partials/sidebar') %>
          <!--**********************************
            Sidebar end
        ***********************************-->

          <!--**********************************
            Content body start
        ***********************************-->
          <div class="content-body">
            <div class="container-fluid">
              <div class="row page-titles mx-0">
                <div class="col-sm-6 p-md-0">
                  <div class="welcome-text">
                    <h4>Olá, {nome}</h4>
                    <p class="mb-0">Crie uma nova Avaliação</p>
                  </div>
                </div>
                <div class="col-sm-6 p-md-0 justify-content-sm-end mt-2 mt-sm-0 d-flex">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">DashBoard</a></li>
                    <li class="breadcrumb-item active"><a href="javascript:void(0)">Nova Vaga</a>
                    </li>
                  </ol>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="card">
                    <div class="card-header">
                      <h4 class="card-title">Criar Avaliação</h4>
                    </div>
                    <style>
                      .choice {
                        margin-bottom: 10px;
                      }

                      .removeChoice,
                      .removeQuestion {
                        margin-left: 10px;
                      }
                    </style>
                    <div class="card-body">
                      <div class="basic-form">
                        <form id="questionsForm">
                          <input type="hidden" id="test_id" value="1"> <!-- Ajuste o valor dinamicamente -->
                          <input type="hidden" id="candidato_id" value="1"> <!-- Ajuste o valor dinamicamente -->
                          <div class="form-group">
                            <label for="test_name">Nome do Teste:</label>
                            <input type="text" id="test_name" class="form-control" required>
                          </div>
                          <div class="form-group">
                            <label for="vaga_name">Nome da Vaga:</label>
                            <select id="vaga_name" class="form-control" required>
                              <% vagas.forEach(function(vaga) { %>
                                <option value="<%= vaga.cargo %>"><%= vaga.cargo %> </option>
                              <% }); %>
                            </select>
                          </div>
                          <div id="questionsContainer"></div>
                          <button type="button" id="addQuestion" class="btn btn-secondary mb-3">Adicionar
                            Pergunta</button><br>
                          <button type="submit" class="btn btn-success">Enviar Perguntas</button>
                          <div id="feedback" class="mt-3"></div>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!--**********************************
            Content body end
        ***********************************-->
          <!--**********************************
            Content body end
        ***********************************-->


          <!--**********************************
            Footer start
        ***********************************-->
          <div class="footer">
            <div class="copyright">
              <p>Copyright © Designed &amp; Developed by <a href="#" target="_blank">Quixkit</a> 2019</p>
            </div>
          </div>
          <!--**********************************
            Footer end
        ***********************************-->

          <!--**********************************
           Support ticket button start
        ***********************************-->

          <!--**********************************
           Support ticket button end
        ***********************************-->


  </div>
  <!--**********************************
        Main wrapper end
    ***********************************-->

  <!--**********************************
        Scripts
    ***********************************-->
  <!-- Required vendors -->
  <script src="../dashBoard/vendor/global/global.min.js"></script>
  <script src="../dashBoard/js/quixnav-init.js"></script>
  <script src="../dashBoard/js/custom.min.js"></script>

  <script src="../dashBoard/vendor/highlightjs/highlight.pack.min.js"></script>
  <!-- Circle progress -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script>
    let questionIndex = 0;

    document.getElementById('addQuestion').addEventListener('click', function () {
      addQuestionForm();
    });

    document.getElementById('questionsForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const test_name = document.getElementById('test_name').value;
      const vaga_name = document.getElementById('vaga_name').value;
      const test_id = document.getElementById('test_id').value;
      const candidato_id = document.getElementById('candidato_id').value;
      const questions = Array.from(document.querySelectorAll('.question')).map((questionDiv, index) => {
        const type = questionDiv.querySelector('.question_type').value;
        const text = questionDiv.querySelector('.question_text').value;
        const choices = type === 'multiple_choice'
          ? Array.from(questionDiv.querySelectorAll('.choice_text')).map(input => input.value)
          : null;

        return { test_name, vaga_name, test_id, candidato_id, type, text, options: choices };
      });

      document.getElementById('feedback').innerHTML = '<div class="alert alert-info">Perguntas enviadas com sucesso!</div>';

      const response = await fetch('/admin/questions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ questions })
      });

      const data = await response.json();
      if (response.ok) {
        document.getElementById('feedback').innerHTML = '<div class="alert alert-success">Perguntas enviadas com sucesso!</div>';
        document.getElementById('questionsForm').reset();
        document.getElementById('questionsContainer').innerHTML = '';
        questionIndex = 0;
      } else {
        document.getElementById('feedback').innerHTML = '<div class="alert alert-danger">Erro ao enviar perguntas: ' + data.error + '</div>';
        console.error(data.details); // Registra o erro detalhado no console do navegador
      }
    });

    function addQuestionForm() {
      const questionDiv = document.createElement('div');
      questionDiv.classList.add('question', 'mb-4');
      questionDiv.innerHTML = `
        <div class="form-group">
          <label for="question_text_${questionIndex}">Pergunta:</label>
          <textarea id="question_text_${questionIndex}" class="form-control question_text" required></textarea>
        </div>
        <div class="form-group">
          <label for="question_type_${questionIndex}">Tipo de Pergunta:</label>
          <select id="question_type_${questionIndex}" class="form-control question_type" required>
            <option value="open">Aberta</option>
            <option value="multiple_choice">Múltipla Escolha</option>
          </select>
        </div>
        <div class="choicesContainer form-group" style="display: none;">
          <label>Opções:</label>
          <div class="choices"></div>
          <button type="button" class="btn btn-secondary addChoice">Adicionar Opção</button>
        </div>
        <button type="button" class="btn btn-danger removeQuestion">Remover Pergunta</button>
      `;

      document.getElementById('questionsContainer').appendChild(questionDiv);

      const typeSelect = questionDiv.querySelector('.question_type');
      typeSelect.addEventListener('change', function () {
        const choicesContainer = questionDiv.querySelector('.choicesContainer');
        if (this.value === 'multiple_choice') {
          choicesContainer.style.display = 'block';
        } else {
          choicesContainer.style.display = 'none';
        }
      });

      const addChoiceButton = questionDiv.querySelector('.addChoice');
      addChoiceButton.addEventListener('click', function () {
        const choiceDiv = document.createElement('div');
        choiceDiv.classList.add('choice', 'input-group', 'mb-2');
        choiceDiv.innerHTML = `
          <input type="text" class="form-control choice_text" placeholder="Opção" required>
          <div class="input-group-append">
            <button type="button" class="btn btn-danger removeChoice">Remover</button>
          </div>
        `;
        questionDiv.querySelector('.choices').appendChild(choiceDiv);

        choiceDiv.querySelector('.removeChoice').addEventListener('click', function () {
          choiceDiv.remove();
        });
      });

      questionDiv.querySelector('.removeQuestion').addEventListener('click', function () {
        questionDiv.remove();
      });

      questionIndex++;
    }
  </script>

</body>

</html>